

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>convlab.modules.word_dst.multiwoz.mdbt_util &mdash; ConvLab 0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../../" src="../../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../../index.html" class="icon icon-home"> ConvLab
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">ConvLab</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../../index.html">Module code</a> &raquo;</li>
        
      <li>convlab.modules.word_dst.multiwoz.mdbt_util</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for convlab.modules.word_dst.multiwoz.mdbt_util</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1"># Modified by Microsoft Corporation.</span>
<span class="c1"># Licensed under the MIT license.</span>

<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">deepcopy</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow.python.client</span> <span class="k">import</span> <span class="n">device_lib</span>

<span class="n">DATA_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)))))),</span> <span class="s1">&#39;data/mdbt&#39;</span><span class="p">)</span>
<span class="n">VALIDATION_URL</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="p">,</span> <span class="s2">&quot;data/validate.json&quot;</span><span class="p">)</span>
<span class="n">WORD_VECTORS_URL</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="p">,</span> <span class="s2">&quot;word-vectors/paragram_300_sl999.txt&quot;</span><span class="p">)</span>
<span class="n">TRAINING_URL</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="p">,</span> <span class="s2">&quot;data/train.json&quot;</span><span class="p">)</span>
<span class="n">ONTOLOGY_URL</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="p">,</span> <span class="s2">&quot;data/ontology.json&quot;</span><span class="p">)</span>
<span class="n">TESTING_URL</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="p">,</span> <span class="s2">&quot;data/test.json&quot;</span><span class="p">)</span>
<span class="n">MODEL_URL</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="p">,</span> <span class="s2">&quot;models/model-1&quot;</span><span class="p">)</span>
<span class="n">GRAPH_URL</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="p">,</span> <span class="s2">&quot;graphs/graph-1&quot;</span><span class="p">)</span>
<span class="n">RESULTS_URL</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="p">,</span> <span class="s2">&quot;results/log-1.txt&quot;</span><span class="p">)</span>

<span class="c1">#ROOT_URL = &#39;../../data/mdbt&#39;</span>

<span class="c1">#VALIDATION_URL = &quot;./data/mdbt/data/validate.json&quot;</span>
<span class="c1">#WORD_VECTORS_URL = &quot;./data/mdbt/word-vectors/paragram_300_sl999.txt&quot;</span>
<span class="c1">#TRAINING_URL = &quot;./data/mdbt/data/train.json&quot;</span>
<span class="c1">#ONTOLOGY_URL = &quot;./data/mdbt/data/ontology.json&quot;</span>
<span class="c1">#TESTING_URL = &quot;./data/mdbt/data/test.json&quot;</span>
<span class="c1">#MODEL_URL = &quot;./data/mdbt/models/model-1&quot;</span>
<span class="c1">#GRAPH_URL = &quot;./data/mdbt/graphs/graph-1&quot;</span>
<span class="c1">#RESULTS_URL = &quot;./data/mdbt/results/log-1.txt&quot;</span>


<span class="n">domains</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;restaurant&#39;</span><span class="p">,</span> <span class="s1">&#39;hotel&#39;</span><span class="p">,</span> <span class="s1">&#39;attraction&#39;</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;taxi&#39;</span><span class="p">]</span>

<span class="n">train_batch_size</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">batches_per_eval</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">no_epochs</span> <span class="o">=</span> <span class="mi">600</span>
<span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;gpu&quot;</span>
<span class="n">start_batch</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">num_slots</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">booking_slots</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">network</span> <span class="o">=</span> <span class="s2">&quot;lstm&quot;</span>
<span class="n">bidirect</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">lstm_num_hidden</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">max_utterance_length</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">vector_dimension</span> <span class="o">=</span> <span class="mi">300</span>
<span class="n">max_no_turns</span> <span class="o">=</span> <span class="mi">22</span>


<span class="c1"># model.py</span>
<div class="viewcode-block" id="get_available_devs"><a class="viewcode-back" href="../../../../../convlab.modules.word_dst.multiwoz.html#convlab.modules.word_dst.multiwoz.mdbt_util.get_available_devs">[docs]</a><span class="k">def</span> <span class="nf">get_available_devs</span><span class="p">():</span>
    <span class="n">local_device_protos</span> <span class="o">=</span> <span class="n">device_lib</span><span class="o">.</span><span class="n">list_local_devices</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">local_device_protos</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">device_type</span> <span class="o">==</span> <span class="s1">&#39;GPU&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="GRU"><a class="viewcode-back" href="../../../../../convlab.modules.word_dst.multiwoz.html#convlab.modules.word_dst.multiwoz.mdbt_util.GRU">[docs]</a><span class="k">class</span> <span class="nc">GRU</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">rnn_cell</span><span class="o">.</span><span class="n">RNNCell</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Create a Gated Recurrent unit to unroll the network through time</span>
<span class="sd">    for combining the current and previous belief states</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">W_h</span><span class="p">,</span> <span class="n">U_h</span><span class="p">,</span> <span class="n">M_h</span><span class="p">,</span> <span class="n">W_m</span><span class="p">,</span> <span class="n">U_m</span><span class="p">,</span> <span class="n">label_size</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">binary_output</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GRU</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">_reuse</span><span class="o">=</span><span class="n">reuse</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_size</span> <span class="o">=</span> <span class="n">label_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">M_h</span> <span class="o">=</span> <span class="n">M_h</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_m</span> <span class="o">=</span> <span class="n">W_m</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">U_m</span> <span class="o">=</span> <span class="n">U_m</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">U_h</span> <span class="o">=</span> <span class="n">U_h</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_h</span> <span class="o">=</span> <span class="n">W_h</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binary_output</span> <span class="o">=</span> <span class="n">binary_output</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">state_only</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_size</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">output_only</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_size</span><span class="p">])</span>
        <span class="n">new_state</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">U_m</span><span class="p">)</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">state_only</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_m</span><span class="p">))</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">U_h</span><span class="p">)</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">output_only</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_h</span><span class="p">)</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">state_only</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">M_h</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary_output</span><span class="p">:</span>
            <span class="n">output_</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output_</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">output_</span><span class="p">,</span> <span class="n">new_state</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">state</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">state_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W_m</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_size</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">output_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W_h</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="define_CNN_model"><a class="viewcode-back" href="../../../../../convlab.modules.word_dst.multiwoz.html#convlab.modules.word_dst.multiwoz.mdbt_util.define_CNN_model">[docs]</a><span class="k">def</span> <span class="nf">define_CNN_model</span><span class="p">(</span><span class="n">utter</span><span class="p">,</span> <span class="n">num_filters</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Better code for defining the CNN model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">filter_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">W</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">filter_size</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filter_sizes</span><span class="p">):</span>
        <span class="n">filter_shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">filter_size</span><span class="p">,</span> <span class="n">vector_dimension</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_filters</span><span class="p">]</span>
        <span class="n">W</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">truncated_normal</span><span class="p">(</span><span class="n">filter_shape</span><span class="p">,</span> <span class="n">stddev</span><span class="o">=</span><span class="mf">0.1</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;F_W&quot;</span><span class="p">))</span>
        <span class="n">b</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">num_filters</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;F_b&quot;</span><span class="p">))</span>

    <span class="n">utter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">utter</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_utterance_length</span><span class="p">,</span> <span class="n">vector_dimension</span><span class="p">])</span>

    <span class="n">hidden_representation</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">num_filters</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="n">pooled_outputs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">filter_size</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filter_sizes</span><span class="p">):</span>
        <span class="c1"># with tf.name_scope(&quot;conv-maxpool-%s&quot; % filter_size):</span>
        <span class="c1"># Convolution Layer</span>
        <span class="n">conv</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">conv2d</span><span class="p">(</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">utter</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">W</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">strides</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;VALID&quot;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;conv_R&quot;</span><span class="p">)</span>
        <span class="c1"># Apply nonlinearity</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">bias_add</span><span class="p">(</span><span class="n">conv</span><span class="p">,</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">)</span>
        <span class="c1"># Maxpooling over the outputs</span>
        <span class="n">pooled</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">max_pool</span><span class="p">(</span>
            <span class="n">h</span><span class="p">,</span>
            <span class="n">ksize</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_utterance_length</span> <span class="o">-</span> <span class="n">filter_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">strides</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;VALID&#39;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;r_&quot;</span><span class="p">)</span>
        <span class="n">pooled_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pooled</span><span class="p">)</span>

        <span class="n">hidden_representation</span> <span class="o">+=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">pooled</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_filters</span><span class="p">])</span>

    <span class="n">hidden_representation</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">hidden_representation</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_no_turns</span><span class="p">,</span> <span class="n">num_filters</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">hidden_representation</span></div>


<div class="viewcode-block" id="lstm_model"><a class="viewcode-back" href="../../../../../convlab.modules.word_dst.multiwoz.html#convlab.modules.word_dst.multiwoz.mdbt_util.lstm_model">[docs]</a><span class="k">def</span> <span class="nf">lstm_model</span><span class="p">(</span><span class="n">text_input</span><span class="p">,</span> <span class="n">utterance_length</span><span class="p">,</span> <span class="n">num_hidden</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">net_type</span><span class="p">,</span> <span class="n">bidir</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Define an Lstm model that will run across the user input and system act</span>
<span class="sd">    :param text_input: [batch_size, max_num_turns, max_utterance_size, vector_dimension]</span>
<span class="sd">    :param utterance_length: number words in every utterance [batch_size, max_num_turns, 1]</span>
<span class="sd">    :param num_hidden: -- int --</span>
<span class="sd">    :param name: The name of lstm network</span>
<span class="sd">    :param net_type: type of the network (&quot;lstm&quot; or &quot;gru&quot; or &quot;rnn&quot;)</span>
<span class="sd">    :param bidir: use a bidirectional network -- bool --</span>
<span class="sd">    :return: output at each state [batch_size, max_num_turns, max_utterance_size, num_hidden],</span>
<span class="sd">     output of the final state [batch_size, max_num_turns, num_hidden]</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">variable_scope</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>

        <span class="n">text_input</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">text_input</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_utterance_length</span><span class="p">,</span> <span class="n">vector_dimension</span><span class="p">])</span>
        <span class="n">utterance_length</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">utterance_length</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">def</span> <span class="nf">rnn</span><span class="p">(</span><span class="n">net_typ</span><span class="p">,</span> <span class="n">num_units</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">net_typ</span> <span class="o">==</span> <span class="s2">&quot;lstm&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">rnn_cell</span><span class="o">.</span><span class="n">LSTMCell</span><span class="p">(</span><span class="n">num_units</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">net_typ</span> <span class="o">==</span> <span class="s2">&quot;gru&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">rnn_cell</span><span class="o">.</span><span class="n">GRUCell</span><span class="p">(</span><span class="n">num_units</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">rnn_cell</span><span class="o">.</span><span class="n">BasicRNNCell</span><span class="p">(</span><span class="n">num_units</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bidir</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">num_hidden</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="n">rev_cell</span> <span class="o">=</span> <span class="n">rnn</span><span class="p">(</span><span class="n">net_type</span><span class="p">,</span> <span class="n">num_hidden</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="n">rnn</span><span class="p">(</span><span class="n">net_type</span><span class="p">,</span> <span class="n">num_hidden</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">lspd</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">bidirectional_dynamic_rnn</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">rev_cell</span><span class="p">,</span> <span class="n">text_input</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
                                                      <span class="n">sequence_length</span><span class="o">=</span><span class="n">utterance_length</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">net_type</span> <span class="o">==</span> <span class="s2">&quot;lstm&quot;</span><span class="p">:</span>
                <span class="n">lspd</span> <span class="o">=</span> <span class="p">(</span><span class="n">lspd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">lspd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

            <span class="n">last_state</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">lspd</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="n">rnn</span><span class="p">(</span><span class="n">net_type</span><span class="p">,</span> <span class="n">num_hidden</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">last_state</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">dynamic_rnn</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">text_input</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">sequence_length</span><span class="o">=</span><span class="n">utterance_length</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">net_type</span> <span class="o">==</span> <span class="s2">&quot;lstm&quot;</span><span class="p">:</span>
                <span class="n">last_state</span> <span class="o">=</span> <span class="n">last_state</span><span class="o">.</span><span class="n">h</span>

        <span class="n">last_state</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">last_state</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_no_turns</span><span class="p">,</span> <span class="n">num_hidden</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">last_state</span></div>


<div class="viewcode-block" id="model_definition"><a class="viewcode-back" href="../../../../../convlab.modules.word_dst.multiwoz.html#convlab.modules.word_dst.multiwoz.mdbt_util.model_definition">[docs]</a><span class="k">def</span> <span class="nf">model_definition</span><span class="p">(</span><span class="n">ontology</span><span class="p">,</span> <span class="n">num_slots</span><span class="p">,</span> <span class="n">slots</span><span class="p">,</span> <span class="n">num_hidden</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">net_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bidir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dev</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Create neural belief tracker model that is defined in my notes. It consists of encoding the user and system input,</span>
<span class="sd">    then use the ontology to decode the encoder in manner that detects if a domain-slot-value class is mentioned</span>
<span class="sd">    :param ontology: numpy array of the embedded vectors of the ontology [num_slots, 3*vector_dimension]</span>
<span class="sd">    :param num_slots: number of ontology classes --int--</span>
<span class="sd">    :param slots: indices of the values of each slot list of lists of ints</span>
<span class="sd">    :param num_hidden: Number of hidden units or dimension of the hidden space</span>
<span class="sd">    :param net_type: The type of the encoder network cnn, lstm, gru, rnn ...etc</span>
<span class="sd">    :param bidir: For recurrent networks should it be bidirectional</span>
<span class="sd">    :param test: This is testing mode (no back-propagation)</span>
<span class="sd">    :param dev: Device to run the model on (cpu or gpu)</span>
<span class="sd">    :return: All input variable/placeholders output metrics (precision, recall, f1-score) and trainer</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># print(&#39;model definition&#39;)</span>
    <span class="c1"># print(ontology, num_slots, slots, num_hidden, net_type, bidir, test, dev)</span>
    <span class="k">global</span> <span class="n">lstm_num_hidden</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">net_type</span><span class="p">:</span>
        <span class="n">net_type</span> <span class="o">=</span> <span class="n">network</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">MDBT: Setting up the type of the network to </span><span class="si">{}</span><span class="s2">..............................&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">net_type</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">bidir</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bidir</span> <span class="o">=</span> <span class="n">bidirect</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>
        <span class="c1"># print(&quot;\tMDBT: Setting up type of the recurrent network to bidirectional {}...........................&quot;.format(bidir))</span>
    <span class="k">if</span> <span class="n">num_hidden</span><span class="p">:</span>
        <span class="n">lstm_num_hidden</span> <span class="o">=</span> <span class="n">num_hidden</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">MDBT: Setting up type of the dimension of the hidden space to </span><span class="si">{}</span><span class="s2">.........................&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_hidden</span><span class="p">))</span>

    <span class="n">ontology</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">ontology</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="c1"># ----------------------------------- Define the input variables --------------------------------------------------</span>
    <span class="n">user_input</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_no_turns</span><span class="p">,</span> <span class="n">max_utterance_length</span><span class="p">,</span> <span class="n">vector_dimension</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">)</span>
    <span class="n">system_input</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_no_turns</span><span class="p">,</span> <span class="n">max_utterance_length</span><span class="p">,</span> <span class="n">vector_dimension</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sys&quot;</span><span class="p">)</span>
    <span class="n">num_turns</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;num_turns&quot;</span><span class="p">)</span>
    <span class="n">user_utterance_lengths</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_no_turns</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;user_sen_len&quot;</span><span class="p">)</span>
    <span class="n">sys_utterance_lengths</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_no_turns</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sys_sen_len&quot;</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_no_turns</span><span class="p">,</span> <span class="n">num_slots</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;labels&quot;</span><span class="p">)</span>
    <span class="n">domain_labels</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_no_turns</span><span class="p">,</span> <span class="n">num_slots</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;domain_labels&quot;</span><span class="p">)</span>
    <span class="c1"># dropout placeholder, 0.5 for training, 1.0 for validation/testing:</span>
    <span class="n">keep_prob</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>

    <span class="c1"># ------------------------------------ Create the Encoder networks ------------------------------------------------</span>
    <span class="n">devs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;/device:CPU:0&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">dev</span> <span class="o">==</span> <span class="s1">&#39;gpu&#39;</span><span class="p">:</span>
        <span class="n">devs</span> <span class="o">=</span> <span class="n">get_available_devs</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">net_type</span> <span class="o">==</span> <span class="s2">&quot;cnn&quot;</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">devs</span><span class="p">[</span><span class="mi">1</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">devs</span><span class="p">)]):</span>
            <span class="c1"># Encode the domain of the user input using a LSTM network</span>
            <span class="n">usr_dom_en</span> <span class="o">=</span> <span class="n">define_CNN_model</span><span class="p">(</span><span class="n">user_input</span><span class="p">,</span> <span class="n">num_filters</span><span class="o">=</span><span class="n">lstm_num_hidden</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;h_u_d&quot;</span><span class="p">)</span>
            <span class="c1"># Encode the domain of the system act using a LSTM network</span>
            <span class="n">sys_dom_en</span> <span class="o">=</span> <span class="n">define_CNN_model</span><span class="p">(</span><span class="n">system_input</span><span class="p">,</span> <span class="n">num_filters</span><span class="o">=</span><span class="n">lstm_num_hidden</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;h_s_d&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">devs</span><span class="p">[</span><span class="mi">2</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">devs</span><span class="p">)]):</span>
            <span class="c1"># Encode the slot of the user input using a CNN network</span>
            <span class="n">usr_slot_en</span> <span class="o">=</span> <span class="n">define_CNN_model</span><span class="p">(</span><span class="n">user_input</span><span class="p">,</span> <span class="n">num_filters</span><span class="o">=</span><span class="n">lstm_num_hidden</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;h_u_s&quot;</span><span class="p">)</span>
            <span class="c1"># Encode the slot of the system act using a CNN network</span>
            <span class="n">sys_slot_en</span> <span class="o">=</span> <span class="n">define_CNN_model</span><span class="p">(</span><span class="n">system_input</span><span class="p">,</span> <span class="n">num_filters</span><span class="o">=</span><span class="n">lstm_num_hidden</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;h_s_s&quot;</span><span class="p">)</span>
            <span class="c1"># Encode the value of the user input using a CNN network</span>
            <span class="n">usr_val_en</span> <span class="o">=</span> <span class="n">define_CNN_model</span><span class="p">(</span><span class="n">user_input</span><span class="p">,</span> <span class="n">num_filters</span><span class="o">=</span><span class="n">lstm_num_hidden</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;h_u_v&quot;</span><span class="p">)</span>
            <span class="c1"># Encode the value of the system act using a CNN network</span>
            <span class="n">sys_val_en</span> <span class="o">=</span> <span class="n">define_CNN_model</span><span class="p">(</span><span class="n">system_input</span><span class="p">,</span> <span class="n">num_filters</span><span class="o">=</span><span class="n">lstm_num_hidden</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;h_s_v&quot;</span><span class="p">)</span>
            <span class="c1"># Encode the user using a CNN network</span>
            <span class="n">usr_en</span> <span class="o">=</span> <span class="n">define_CNN_model</span><span class="p">(</span><span class="n">user_input</span><span class="p">,</span> <span class="n">num_filters</span><span class="o">=</span><span class="n">lstm_num_hidden</span> <span class="o">//</span> <span class="mi">5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;h_u&quot;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">devs</span><span class="p">[</span><span class="mi">1</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">devs</span><span class="p">)]):</span>
            <span class="c1"># Encode the domain of the user input using a LSTM network</span>
            <span class="n">usr_dom_en</span> <span class="o">=</span> <span class="n">lstm_model</span><span class="p">(</span><span class="n">user_input</span><span class="p">,</span> <span class="n">user_utterance_lengths</span><span class="p">,</span> <span class="n">lstm_num_hidden</span><span class="p">,</span> <span class="s2">&quot;h_u_d&quot;</span><span class="p">,</span> <span class="n">net_type</span><span class="p">,</span> <span class="n">bidir</span><span class="p">)</span>
            <span class="n">usr_dom_en</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">usr_dom_en</span><span class="p">,</span> <span class="n">keep_prob</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;h_u_d_out&quot;</span><span class="p">)</span>
            <span class="c1"># Encode the domain of the system act using a LSTM network</span>
            <span class="n">sys_dom_en</span> <span class="o">=</span> <span class="n">lstm_model</span><span class="p">(</span><span class="n">system_input</span><span class="p">,</span> <span class="n">sys_utterance_lengths</span><span class="p">,</span> <span class="n">lstm_num_hidden</span><span class="p">,</span> <span class="s2">&quot;h_s_d&quot;</span><span class="p">,</span> <span class="n">net_type</span><span class="p">,</span> <span class="n">bidir</span><span class="p">)</span>
            <span class="n">sys_dom_en</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">sys_dom_en</span><span class="p">,</span> <span class="n">keep_prob</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;h_s_d_out&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">devs</span><span class="p">[</span><span class="mi">2</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">devs</span><span class="p">)]):</span>
            <span class="c1"># Encode the slot of the user input using a LSTM network</span>
            <span class="n">usr_slot_en</span> <span class="o">=</span> <span class="n">lstm_model</span><span class="p">(</span><span class="n">user_input</span><span class="p">,</span> <span class="n">user_utterance_lengths</span><span class="p">,</span> <span class="n">lstm_num_hidden</span><span class="p">,</span> <span class="s2">&quot;h_u_s&quot;</span><span class="p">,</span> <span class="n">net_type</span><span class="p">,</span> <span class="n">bidir</span><span class="p">)</span>
            <span class="n">usr_slot_en</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">usr_slot_en</span><span class="p">,</span> <span class="n">keep_prob</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;h_u_s_out&quot;</span><span class="p">)</span>
            <span class="c1"># Encode the slot of the system act using a LSTM network</span>
            <span class="n">sys_slot_en</span> <span class="o">=</span> <span class="n">lstm_model</span><span class="p">(</span><span class="n">system_input</span><span class="p">,</span> <span class="n">sys_utterance_lengths</span><span class="p">,</span> <span class="n">lstm_num_hidden</span><span class="p">,</span> <span class="s2">&quot;h_s_s&quot;</span><span class="p">,</span> <span class="n">net_type</span><span class="p">,</span> <span class="n">bidir</span><span class="p">)</span>
            <span class="n">sys_slot_en</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">sys_slot_en</span><span class="p">,</span> <span class="n">keep_prob</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;h_s_s_out&quot;</span><span class="p">)</span>
            <span class="c1"># Encode the value of the user input using a LSTM network</span>
            <span class="n">usr_val_en</span> <span class="o">=</span> <span class="n">lstm_model</span><span class="p">(</span><span class="n">user_input</span><span class="p">,</span> <span class="n">user_utterance_lengths</span><span class="p">,</span> <span class="n">lstm_num_hidden</span><span class="p">,</span> <span class="s2">&quot;h_u_v&quot;</span><span class="p">,</span> <span class="n">net_type</span><span class="p">,</span> <span class="n">bidir</span><span class="p">)</span>
            <span class="n">usr_val_en</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">usr_val_en</span><span class="p">,</span> <span class="n">keep_prob</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;h_u_v_out&quot;</span><span class="p">)</span>
            <span class="c1"># Encode the value of the system act using a LSTM network</span>
            <span class="n">sys_val_en</span> <span class="o">=</span> <span class="n">lstm_model</span><span class="p">(</span><span class="n">system_input</span><span class="p">,</span> <span class="n">sys_utterance_lengths</span><span class="p">,</span> <span class="n">lstm_num_hidden</span><span class="p">,</span> <span class="s2">&quot;h_s_v&quot;</span><span class="p">,</span> <span class="n">net_type</span><span class="p">,</span> <span class="n">bidir</span><span class="p">)</span>
            <span class="n">sys_val_en</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">sys_val_en</span><span class="p">,</span> <span class="n">keep_prob</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;h_s_v_out&quot;</span><span class="p">)</span>
            <span class="c1"># Encode the user using a LSTM network</span>
            <span class="n">usr_en</span> <span class="o">=</span> <span class="n">lstm_model</span><span class="p">(</span><span class="n">user_input</span><span class="p">,</span> <span class="n">user_utterance_lengths</span><span class="p">,</span> <span class="n">lstm_num_hidden</span> <span class="o">//</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;h_u&quot;</span><span class="p">,</span> <span class="n">net_type</span><span class="p">,</span> <span class="n">bidir</span><span class="p">)</span>
            <span class="n">usr_en</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">usr_en</span><span class="p">,</span> <span class="n">keep_prob</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;h_u_out&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">devs</span><span class="p">[</span><span class="mi">1</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">devs</span><span class="p">)]):</span>
        <span class="n">usr_dom_en</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">usr_dom_en</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_slots</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;h_u_d&quot;</span><span class="p">)</span>
        <span class="n">sys_dom_en</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">sys_dom_en</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_slots</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;h_s_d&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">devs</span><span class="p">[</span><span class="mi">2</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">devs</span><span class="p">)]):</span>
        <span class="n">usr_slot_en</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">usr_slot_en</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_slots</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;h_u_s&quot;</span><span class="p">)</span>
        <span class="n">sys_slot_en</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">sys_slot_en</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_slots</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;h_s_s&quot;</span><span class="p">)</span>
        <span class="n">usr_val_en</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">usr_val_en</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_slots</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;h_u_v&quot;</span><span class="p">)</span>
        <span class="n">sys_val_en</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">sys_val_en</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_slots</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;h_s_v&quot;</span><span class="p">)</span>
        <span class="n">usr_en</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">usr_en</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_slots</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;h_u&quot;</span><span class="p">)</span>

    <span class="c1"># All encoding vectors have size [batch_size, max_turns, num_slots, num_hidden]</span>

    <span class="c1"># Matrix that transforms the ontology from the embedding space to the hidden representation</span>
    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">devs</span><span class="p">[</span><span class="mi">1</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">devs</span><span class="p">)]):</span>
        <span class="n">W_onto_domain</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random_normal</span><span class="p">([</span><span class="n">vector_dimension</span><span class="p">,</span> <span class="n">lstm_num_hidden</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;W_onto_domain&quot;</span><span class="p">)</span>
        <span class="n">W_onto_slot</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random_normal</span><span class="p">([</span><span class="n">vector_dimension</span><span class="p">,</span> <span class="n">lstm_num_hidden</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;W_onto_slot&quot;</span><span class="p">)</span>
        <span class="n">W_onto_value</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random_normal</span><span class="p">([</span><span class="n">vector_dimension</span><span class="p">,</span> <span class="n">lstm_num_hidden</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;W_onto_value&quot;</span><span class="p">)</span>

        <span class="c1"># And biases</span>
        <span class="n">b_onto_domain</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">lstm_num_hidden</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;b_onto_domain&quot;</span><span class="p">)</span>
        <span class="n">b_onto_slot</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">lstm_num_hidden</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;b_onto_slot&quot;</span><span class="p">)</span>
        <span class="n">b_onto_value</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">lstm_num_hidden</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;b_onto_value&quot;</span><span class="p">)</span>

        <span class="c1"># Apply the transformation from the embedding space of the ontology to the hidden space</span>
        <span class="n">domain_vec</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">ontology</span><span class="p">,</span> <span class="n">begin</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vector_dimension</span><span class="p">])</span>
        <span class="n">slot_vec</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">ontology</span><span class="p">,</span> <span class="n">begin</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">vector_dimension</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vector_dimension</span><span class="p">])</span>
        <span class="n">value_vec</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">ontology</span><span class="p">,</span> <span class="n">begin</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">vector_dimension</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vector_dimension</span><span class="p">])</span>
        <span class="c1"># Each [num_slots, vector_dimension]</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">domain_vec</span><span class="p">,</span> <span class="n">W_onto_domain</span><span class="p">)</span> <span class="o">+</span> <span class="n">b_onto_domain</span><span class="p">),</span> <span class="n">keep_prob</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">slot_vec</span><span class="p">,</span> <span class="n">W_onto_slot</span><span class="p">)</span> <span class="o">+</span> <span class="n">b_onto_slot</span><span class="p">),</span> <span class="n">keep_prob</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">value_vec</span><span class="p">,</span> <span class="n">W_onto_value</span><span class="p">)</span> <span class="o">+</span> <span class="n">b_onto_value</span><span class="p">),</span> <span class="n">keep_prob</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;v&quot;</span><span class="p">)</span>
        <span class="c1"># Each [num_slots, num_hidden]</span>

        <span class="c1"># Apply the comparison mechanism for all the user and system utterances and ontology values</span>
        <span class="n">domain_user</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">usr_dom_en</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;domain_user&quot;</span><span class="p">)</span>
        <span class="n">domain_sys</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">sys_dom_en</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;domain_sys&quot;</span><span class="p">)</span>
        <span class="n">slot_user</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">usr_slot_en</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;slot_user&quot;</span><span class="p">)</span>
        <span class="n">slot_sys</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">sys_slot_en</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;slot_sys&quot;</span><span class="p">)</span>
        <span class="n">value_user</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">usr_val_en</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;value_user&quot;</span><span class="p">)</span>
        <span class="n">value_sys</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">sys_val_en</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;value_sys&quot;</span><span class="p">)</span>
        <span class="c1"># All of size [batch_size, max_turns, num_slots, num_hidden]</span>

        <span class="c1"># -------------- Domain Detection -------------------------------------------------------------------------</span>
        <span class="n">W_domain</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random_normal</span><span class="p">([</span><span class="mi">2</span> <span class="o">*</span> <span class="n">lstm_num_hidden</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;W_domain&quot;</span><span class="p">)</span>
        <span class="n">b_domain</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;b_domain&quot;</span><span class="p">)</span>
        <span class="n">y_d</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">domain_user</span><span class="p">,</span> <span class="n">domain_sys</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span> <span class="n">W_domain</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                         <span class="o">+</span> <span class="n">b_domain</span><span class="p">)</span>  <span class="c1"># [batch_size, max_turns, num_slots]</span>

    <span class="c1"># -------- Run through each of the 3 case ( inform, request, confirm) and decode the inferred state ---------</span>
    <span class="c1"># 1 Inform (User is informing the system about the goal, e.g. &quot;I am looking for a place to stay in the centre&quot;)</span>
    <span class="n">W_inform</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random_normal</span><span class="p">([</span><span class="mi">2</span> <span class="o">*</span> <span class="n">lstm_num_hidden</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;W_inform&quot;</span><span class="p">)</span>
    <span class="n">b_inform</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random_normal</span><span class="p">([</span><span class="mi">1</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;b_inform&quot;</span><span class="p">)</span>
    <span class="n">inform</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">slot_user</span><span class="p">,</span> <span class="n">value_user</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span> <span class="n">W_inform</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span> <span class="n">b_inform</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;inform&quot;</span><span class="p">)</span>  <span class="c1"># [batch_size, max_turns, num_slots]</span>

    <span class="c1"># 2 Request (The system is requesting information from the user, e.g. &quot;what type of food would you like?&quot;)</span>
    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">devs</span><span class="p">[</span><span class="mi">2</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">devs</span><span class="p">)]):</span>
        <span class="n">W_request</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random_normal</span><span class="p">([</span><span class="mi">2</span> <span class="o">*</span> <span class="n">lstm_num_hidden</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;W_request&quot;</span><span class="p">)</span>
        <span class="n">b_request</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random_normal</span><span class="p">([</span><span class="mi">1</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;b_request&quot;</span><span class="p">)</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">slot_sys</span><span class="p">,</span> <span class="n">value_user</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span> <span class="n">W_request</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
                         <span class="n">b_request</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>  <span class="c1"># [batch_size, max_turns, num_slots]</span>

    <span class="c1"># 3 Confirm (The system is confirming values given by the user, e.g. &quot;How about turkish food?&quot;)</span>
    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">devs</span><span class="p">[</span><span class="mi">3</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">devs</span><span class="p">)]):</span>
        <span class="n">size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">lstm_num_hidden</span> <span class="o">+</span> <span class="n">lstm_num_hidden</span> <span class="o">//</span> <span class="mi">5</span>
        <span class="n">W_confirm</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random_normal</span><span class="p">([</span><span class="n">size</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;W_confirm&quot;</span><span class="p">)</span>
        <span class="n">b_confirm</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random_normal</span><span class="p">([</span><span class="mi">1</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;b_confirm&quot;</span><span class="p">)</span>
        <span class="n">confirm</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">slot_sys</span><span class="p">,</span> <span class="n">value_sys</span><span class="p">,</span> <span class="n">usr_en</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span> <span class="n">W_confirm</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
            <span class="n">b_confirm</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;confirm&quot;</span><span class="p">)</span>  <span class="c1"># [batch_size, max_turns, num_slots]</span>

    <span class="n">output</span> <span class="o">=</span> <span class="n">inform</span> <span class="o">+</span> <span class="n">request</span> <span class="o">+</span> <span class="n">confirm</span>

    <span class="c1"># -------------------- Adding the belief update RNN with memory cell (Taken from previous model) -------------------</span>
    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">devs</span><span class="p">[</span><span class="mi">2</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">devs</span><span class="p">)]):</span>
        <span class="n">domain_memory</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random_normal</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;domain_memory&quot;</span><span class="p">)</span>
        <span class="n">domain_current</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random_normal</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;domain_current&quot;</span><span class="p">)</span>
        <span class="n">domain_M_h</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random_normal</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;domain_M_h&quot;</span><span class="p">)</span>
        <span class="n">domain_W_m</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random_normal</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;domain_W_m&quot;</span><span class="p">))</span>
        <span class="n">domain_U_m</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random_normal</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;domain_U_m&quot;</span><span class="p">)</span>
    <span class="n">a_memory</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random_normal</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;a_memory&quot;</span><span class="p">)</span>
    <span class="n">b_memory</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random_normal</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;b_memory&quot;</span><span class="p">)</span>
    <span class="n">a_current</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random_normal</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;a_current&quot;</span><span class="p">)</span>
    <span class="n">b_current</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random_normal</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;b_current&quot;</span><span class="p">)</span>
    <span class="n">M_h_a</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random_normal</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;M_h_a&quot;</span><span class="p">)</span>
    <span class="n">M_h_b</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random_normal</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;M_h_b&quot;</span><span class="p">)</span>
    <span class="n">W_m_a</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random_normal</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;W_m_a&quot;</span><span class="p">)</span>
    <span class="n">W_m_b</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random_normal</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;W_m_b&quot;</span><span class="p">)</span>
    <span class="n">U_m_a</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random_normal</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;U_m_a&quot;</span><span class="p">)</span>
    <span class="n">U_m_b</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random_normal</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;U_m_b&quot;</span><span class="p">)</span>

    <span class="c1"># ---------------------------------- Unroll the domain over time --------------------------------------------------</span>
    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">devs</span><span class="p">[</span><span class="mi">1</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">devs</span><span class="p">)]):</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="n">GRU</span><span class="p">(</span><span class="n">domain_memory</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_slots</span><span class="p">)),</span> <span class="n">domain_current</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_slots</span><span class="p">)),</span>
                   <span class="n">domain_M_h</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_slots</span><span class="p">)),</span> <span class="n">domain_W_m</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_slots</span><span class="p">)),</span>
                   <span class="n">domain_U_m</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_slots</span><span class="p">)),</span> <span class="n">num_slots</span><span class="p">,</span>
                   <span class="n">binary_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">y_d</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">dynamic_rnn</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">y_d</span><span class="p">,</span> <span class="n">sequence_length</span><span class="o">=</span><span class="n">num_turns</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="n">domain_loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">sigmoid_cross_entropy_with_logits</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">domain_labels</span><span class="p">,</span> <span class="n">logits</span><span class="o">=</span><span class="n">y_d</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;domain_loss&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">num_slots</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">slots</span><span class="p">))</span>

        <span class="n">y_d</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">y_d</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">devs</span><span class="p">[</span><span class="mi">0</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">devs</span><span class="p">)]):</span>

        <span class="n">loss</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">slots</span><span class="p">))]</span>
        <span class="n">slot_pred</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">slots</span><span class="p">))]</span>
        <span class="n">slot_label</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">slots</span><span class="p">))]</span>
        <span class="n">val_pred</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">slots</span><span class="p">))]</span>
        <span class="n">val_label</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">slots</span><span class="p">))]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">slots</span><span class="p">))]</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">slots</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">slots</span><span class="p">)):</span>

            <span class="n">num_values</span> <span class="o">=</span> <span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># For the none case</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">slots</span><span class="p">[:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">test</span><span class="p">:</span>
                <span class="n">domain_output</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">y_d</span><span class="p">),</span> <span class="n">begin</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">domain_output</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">domain_labels</span><span class="p">,</span> <span class="n">begin</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
            <span class="n">max_val</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">domain_output</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="c1"># tf.assert_less_equal(max_val, 1.0)</span>
            <span class="c1"># tf.assert_equal(tf.round(max_val), max_val)</span>
            <span class="n">domain_output</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">domain_output</span><span class="p">)),</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">max_val</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">slot_output</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">begin</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
            <span class="n">slot_output</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">slot_output</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">output</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">max_no_turns</span><span class="p">,</span> <span class="mi">1</span><span class="p">])],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">labels_output</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">begin</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
            <span class="n">max_val</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">labels_output</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="c1"># tf.assert_less_equal(max_val, 1.0)</span>
            <span class="c1"># tf.assert_equal(tf.round(max_val), max_val)</span>
            <span class="n">slot_label</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_val</span>
            <span class="c1"># [Batch_size, max_turns, 1]</span>
            <span class="n">labels_output</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">labels_output</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">max_val</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="c1"># [Batch_size, max_turns]</span>
            <span class="n">val_label</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">labels_output</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>
            <span class="c1"># [Batch_size, max_turns, 1]</span>

            <span class="n">diag_memory</span> <span class="o">=</span> <span class="n">a_memory</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_values</span><span class="p">))</span>
            <span class="n">non_diag_memory</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matrix_set_diag</span><span class="p">(</span><span class="n">b_memory</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">num_values</span><span class="p">,</span> <span class="n">num_values</span><span class="p">]),</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_values</span><span class="p">))</span>
            <span class="n">W_memory</span> <span class="o">=</span> <span class="n">diag_memory</span> <span class="o">+</span> <span class="n">non_diag_memory</span>

            <span class="n">diag_current</span> <span class="o">=</span> <span class="n">a_current</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_values</span><span class="p">))</span>
            <span class="n">non_diag_current</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matrix_set_diag</span><span class="p">(</span><span class="n">b_current</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">num_values</span><span class="p">,</span> <span class="n">num_values</span><span class="p">]),</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_values</span><span class="p">))</span>
            <span class="n">W_current</span> <span class="o">=</span> <span class="n">diag_current</span> <span class="o">+</span> <span class="n">non_diag_current</span>

            <span class="n">diag_M_h</span> <span class="o">=</span> <span class="n">M_h_a</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_values</span><span class="p">))</span>
            <span class="n">non_diag_M_h</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matrix_set_diag</span><span class="p">(</span><span class="n">M_h_b</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">num_values</span><span class="p">,</span> <span class="n">num_values</span><span class="p">]),</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_values</span><span class="p">))</span>
            <span class="n">M_h</span> <span class="o">=</span> <span class="n">diag_M_h</span> <span class="o">+</span> <span class="n">non_diag_M_h</span>

            <span class="n">diag_U_m</span> <span class="o">=</span> <span class="n">U_m_a</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_values</span><span class="p">))</span>
            <span class="n">non_diag_U_m</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matrix_set_diag</span><span class="p">(</span><span class="n">U_m_b</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">num_values</span><span class="p">,</span> <span class="n">num_values</span><span class="p">]),</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_values</span><span class="p">))</span>
            <span class="n">U_m</span> <span class="o">=</span> <span class="n">diag_U_m</span> <span class="o">+</span> <span class="n">non_diag_U_m</span>

            <span class="n">diag_W_m</span> <span class="o">=</span> <span class="n">W_m_a</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_values</span><span class="p">))</span>
            <span class="n">non_diag_W_m</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matrix_set_diag</span><span class="p">(</span><span class="n">W_m_b</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">num_values</span><span class="p">,</span> <span class="n">num_values</span><span class="p">]),</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_values</span><span class="p">))</span>
            <span class="n">W_m</span> <span class="o">=</span> <span class="n">diag_W_m</span> <span class="o">+</span> <span class="n">non_diag_W_m</span>

            <span class="n">cell</span> <span class="o">=</span> <span class="n">GRU</span><span class="p">(</span><span class="n">W_memory</span><span class="p">,</span> <span class="n">W_current</span><span class="p">,</span> <span class="n">M_h</span><span class="p">,</span> <span class="n">W_m</span><span class="p">,</span> <span class="n">U_m</span><span class="p">,</span> <span class="n">num_values</span><span class="p">)</span>
            <span class="n">y_predict</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">dynamic_rnn</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">slot_output</span><span class="p">,</span> <span class="n">sequence_length</span><span class="o">=</span><span class="n">num_turns</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

            <span class="n">y_predict</span> <span class="o">=</span> <span class="n">y_predict</span> <span class="o">+</span> <span class="mf">1000000.0</span> <span class="o">*</span> <span class="n">domain_output</span>
            <span class="c1"># [Batch_size, max_turns, num_values]</span>

            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">y_predict</span><span class="p">)</span>
            <span class="n">val_pred</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
            <span class="c1"># [Batch_size, max_turns, 1]</span>
            <span class="n">y_pred</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="n">num_values</span><span class="p">),</span>
                                 <span class="n">begin</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_values</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">begin</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_values</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">slot_pred</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">y_pred</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">keep_dims</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
            <span class="c1"># [Batch_size, max_turns, 1]</span>
            <span class="n">loss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">sparse_softmax_cross_entropy_with_logits</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">labels_output</span><span class="p">,</span> <span class="n">logits</span><span class="o">=</span><span class="n">y_predict</span><span class="p">)</span>
            <span class="c1"># [Batch_size, max_turns]</span>

    <span class="c1"># ---------------- Compute the output and the loss function (cross_entropy) and add to optimizer--------------------</span>
    <span class="n">cross_entropy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">add_n</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cross_entropy&quot;</span><span class="p">)</span>
    <span class="c1"># Add the error from the domains</span>
    <span class="n">cross_entropy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cross_entropy</span><span class="p">,</span> <span class="n">domain_loss</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;total_loss&quot;</span><span class="p">)</span>

    <span class="n">y</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">sequence_mask</span><span class="p">(</span><span class="n">num_turns</span><span class="p">,</span> <span class="n">maxlen</span><span class="o">=</span><span class="n">max_no_turns</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">mask_extended</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_slots</span><span class="p">])</span>
    <span class="n">cross_entropy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">mask</span> <span class="o">*</span> <span class="n">cross_entropy</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">num_turns</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">AdamOptimizer</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
    <span class="n">train_step</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">cross_entropy</span><span class="p">,</span> <span class="n">colocate_gradients_with_ops</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># ----------------- Get the precision, recall f1-score and accuracy -----------------------------------------------</span>

    <span class="c1"># Domain accuracy</span>
    <span class="n">true_predictions</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">domain_labels</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_slots</span><span class="p">])</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">y_d</span><span class="p">)</span> <span class="o">*</span> <span class="n">mask_extended</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_slots</span><span class="p">])</span>

    <span class="n">y_d</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">y_d</span> <span class="o">*</span> <span class="n">mask_extended</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_slots</span><span class="p">])</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">domain_accuracy</span> <span class="o">=</span> <span class="n">get_metrics</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">true_predictions</span><span class="p">,</span> <span class="n">num_turns</span><span class="p">,</span> <span class="n">mask_extended</span><span class="p">,</span> <span class="n">num_slots</span><span class="p">)</span>

    <span class="n">mask_extended_2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">slots</span><span class="p">)])</span>

    <span class="c1"># Slot accuracy</span>
    <span class="n">true_predictions</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">slot_label</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">slots</span><span class="p">)])</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">slot_pred</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">mask_extended_2</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">slots</span><span class="p">)])</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">slot_accuracy</span> <span class="o">=</span> <span class="n">get_metrics</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">true_predictions</span><span class="p">,</span> <span class="n">num_turns</span><span class="p">,</span> <span class="n">mask_extended_2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">slots</span><span class="p">))</span>

    <span class="c1"># accuracy</span>
    <span class="k">if</span> <span class="n">test</span><span class="p">:</span>
        <span class="n">value_accuracy</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mask_extended_3</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">slots</span><span class="p">)):</span>
            <span class="n">true_predictions</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">val_label</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">mask_extended_3</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">predictions</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">val_pred</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">mask_extended_3</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">value_acc</span> <span class="o">=</span> <span class="n">get_metrics</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">true_predictions</span><span class="p">,</span> <span class="n">num_turns</span><span class="p">,</span> <span class="n">mask_extended_3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">value_accuracy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value_acc</span><span class="p">)</span>

        <span class="n">value_accuracy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">value_accuracy</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">true_predictions</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">val_label</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">mask_extended_2</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">slots</span><span class="p">)])</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">val_pred</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">mask_extended_2</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">slots</span><span class="p">)])</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">value_accuracy</span> <span class="o">=</span> <span class="n">get_metrics</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">true_predictions</span><span class="p">,</span> <span class="n">num_turns</span><span class="p">,</span> <span class="n">mask_extended_2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">slots</span><span class="p">))</span>

    <span class="c1"># Value f1score a</span>
    <span class="n">true_predictions</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_slots</span><span class="p">])</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">mask_extended</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_slots</span><span class="p">])</span>

    <span class="n">precision</span><span class="p">,</span> <span class="n">recall</span><span class="p">,</span> <span class="n">value_f1_score</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_metrics</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">true_predictions</span><span class="p">,</span> <span class="n">num_turns</span><span class="p">,</span>
                                                       <span class="n">mask_extended</span><span class="p">,</span> <span class="n">num_slots</span><span class="p">)</span>

    <span class="n">y_</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_slots</span><span class="p">])</span>

    <span class="c1"># -------------------- Summarise the statistics of training to be viewed in tensorboard-----------------------------</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="s2">&quot;domain_accuracy&quot;</span><span class="p">,</span> <span class="n">domain_accuracy</span><span class="p">)</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="s2">&quot;slot_accuracy&quot;</span><span class="p">,</span> <span class="n">slot_accuracy</span><span class="p">)</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="s2">&quot;value_accuracy&quot;</span><span class="p">,</span> <span class="n">value_accuracy</span><span class="p">)</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="s2">&quot;value_f1_score&quot;</span><span class="p">,</span> <span class="n">value_f1_score</span><span class="p">)</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="s2">&quot;cross_entropy&quot;</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">cross_entropy</span><span class="p">))</span>

    <span class="n">value_f1_score</span> <span class="o">=</span> <span class="p">[</span><span class="n">precision</span><span class="p">,</span> <span class="n">recall</span><span class="p">,</span> <span class="n">value_f1_score</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">user_input</span><span class="p">,</span> <span class="n">system_input</span><span class="p">,</span> <span class="n">num_turns</span><span class="p">,</span> <span class="n">user_utterance_lengths</span><span class="p">,</span> <span class="n">sys_utterance_lengths</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">domain_labels</span><span class="p">,</span> \
           <span class="n">domain_accuracy</span><span class="p">,</span> <span class="n">slot_accuracy</span><span class="p">,</span> <span class="n">value_accuracy</span><span class="p">,</span> <span class="n">value_f1_score</span><span class="p">,</span> <span class="n">train_step</span><span class="p">,</span> <span class="n">keep_prob</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> \
           <span class="n">true_predictions</span><span class="p">,</span> <span class="p">[</span><span class="n">y_</span><span class="p">,</span> <span class="n">y_d</span><span class="p">]</span></div>


<div class="viewcode-block" id="get_metrics"><a class="viewcode-back" href="../../../../../convlab.modules.word_dst.multiwoz.html#convlab.modules.word_dst.multiwoz.mdbt_util.get_metrics">[docs]</a><span class="k">def</span> <span class="nf">get_metrics</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">true_predictions</span><span class="p">,</span> <span class="n">no_turns</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">num_slots</span><span class="p">):</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_slots</span><span class="p">])</span>
    <span class="n">correct_prediction</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">true_predictions</span><span class="p">),</span> <span class="s2">&quot;float32&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">mask</span>

    <span class="n">num_positives</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">true_predictions</span><span class="p">)</span>
    <span class="n">classified_positives</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>

    <span class="n">true_positives</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">true_predictions</span><span class="p">)</span>
    <span class="n">num_true_positives</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">true_positives</span><span class="p">)</span>

    <span class="n">recall</span> <span class="o">=</span> <span class="n">num_true_positives</span> <span class="o">/</span> <span class="n">num_positives</span>
    <span class="n">precision</span> <span class="o">=</span> <span class="n">num_true_positives</span> <span class="o">/</span> <span class="n">classified_positives</span>
    <span class="n">f_score</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">recall</span> <span class="o">*</span> <span class="n">precision</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">recall</span> <span class="o">+</span> <span class="n">precision</span><span class="p">)</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">correct_prediction</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">no_turns</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_slots</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">precision</span><span class="p">,</span> <span class="n">recall</span><span class="p">,</span> <span class="n">f_score</span><span class="p">,</span> <span class="n">accuracy</span></div>



<span class="c1"># main.py</span>
<div class="viewcode-block" id="normalise_word_vectors"><a class="viewcode-back" href="../../../../../convlab.modules.word_dst.multiwoz.html#convlab.modules.word_dst.multiwoz.mdbt_util.normalise_word_vectors">[docs]</a><span class="k">def</span> <span class="nf">normalise_word_vectors</span><span class="p">(</span><span class="n">word_vectors</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method normalises the collection of word vectors provided in the word_vectors dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">word_vectors</span><span class="p">:</span>
        <span class="n">word_vectors</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">/=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">word_vectors</span><span class="p">[</span><span class="n">word</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>
        <span class="n">word_vectors</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">*=</span> <span class="n">norm</span>
    <span class="k">return</span> <span class="n">word_vectors</span></div>


<div class="viewcode-block" id="xavier_vector"><a class="viewcode-back" href="../../../../../convlab.modules.word_dst.multiwoz.html#convlab.modules.word_dst.multiwoz.mdbt_util.xavier_vector">[docs]</a><span class="k">def</span> <span class="nf">xavier_vector</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">D</span><span class="o">=</span><span class="mi">300</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a D-dimensional vector for the word.</span>

<span class="sd">    We hash the word to always get the same vector for the given word.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">hash_string</span><span class="p">(</span><span class="n">_s</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="n">_s</span><span class="p">))</span> <span class="o">%</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">seed_value</span> <span class="o">=</span> <span class="n">hash_string</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed_value</span><span class="p">)</span>

    <span class="n">neg_value</span> <span class="o">=</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
    <span class="n">pos_value</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>

    <span class="n">rsample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="n">neg_value</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">pos_value</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">D</span><span class="p">,))</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">rsample</span><span class="p">)</span>
    <span class="n">rsample_normed</span> <span class="o">=</span> <span class="n">rsample</span><span class="o">/</span><span class="n">norm</span>

    <span class="k">return</span> <span class="n">rsample_normed</span></div>


<div class="viewcode-block" id="load_ontology"><a class="viewcode-back" href="../../../../../convlab.modules.word_dst.multiwoz.html#convlab.modules.word_dst.multiwoz.mdbt_util.load_ontology">[docs]</a><span class="k">def</span> <span class="nf">load_ontology</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">word_vectors</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Load the ontology from a file</span>
<span class="sd">    :param url: to the ontology</span>
<span class="sd">    :param word_vectors: dictionary of the word embeddings [words, vector_dimension]</span>
<span class="sd">    :return: list([domain-slot-value]), [no_slots, vector_dimension]</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">global</span> <span class="n">num_slots</span>
    <span class="c1"># print(&quot;\tMDBT: Loading the ontology....................&quot;)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">),</span> <span class="n">object_pairs_hook</span><span class="o">=</span><span class="n">OrderedDict</span><span class="p">)</span>
    <span class="n">slot_values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ontology</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">slots_values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ontology_vectors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">slots</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="p">[</span><span class="n">domain</span><span class="p">,</span> <span class="n">slot</span><span class="p">]</span> <span class="o">=</span> <span class="n">slots</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">domain</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">domains</span> <span class="ow">or</span> <span class="n">slot</span> <span class="o">==</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">slots</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;book&quot;</span> <span class="ow">in</span> <span class="n">slot</span><span class="p">:</span>
            <span class="p">[</span><span class="n">slot</span><span class="p">,</span> <span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="n">slot</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="n">booking_slots</span><span class="p">[</span><span class="n">domain</span><span class="o">+</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">slot</span> <span class="o">==</span> <span class="s2">&quot;departure&quot;</span> <span class="ow">or</span> <span class="n">slot</span> <span class="o">==</span> <span class="s2">&quot;destination&quot;</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;place&quot;</span><span class="p">]</span>
        <span class="n">domain_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">process_text</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">word_vectors</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">domain</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">word_vectors</span><span class="p">:</span>
            <span class="n">word_vectors</span><span class="p">[</span><span class="n">domain</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">domain_vec</span>
        <span class="n">slot_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">process_text</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">word_vectors</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">domain</span><span class="o">+</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="n">slot</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">slots_values</span><span class="p">:</span>
            <span class="n">slots_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">domain</span><span class="o">+</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="n">slot</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">slot</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">word_vectors</span><span class="p">:</span>
            <span class="n">word_vectors</span><span class="p">[</span><span class="n">slot</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">slot_vec</span>
        <span class="n">slot_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="n">ontology</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">domain</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">slot</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">value_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">process_text</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">word_vectors</span><span class="p">,</span> <span class="n">print_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">word_vectors</span><span class="p">:</span>
                <span class="n">word_vectors</span><span class="p">[</span><span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">value_vec</span>
            <span class="n">ontology_vectors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">domain_vec</span><span class="p">,</span> <span class="n">slot_vec</span><span class="p">,</span> <span class="n">value_vec</span><span class="p">)))</span>

    <span class="n">num_slots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">slots_values</span><span class="p">)</span>
    <span class="c1"># print(&quot;\tMDBT: We have about {} values&quot;.format(len(ontology)))</span>
    <span class="c1"># print(&quot;\tMDBT: The Full Ontology is:&quot;)</span>
    <span class="c1"># print(ontology)</span>
    <span class="c1"># print(&quot;\tMDBT: The slots in this ontology:&quot;)</span>
    <span class="c1"># print(slots_values)</span>
    <span class="k">return</span> <span class="n">ontology</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ontology_vectors</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">),</span> <span class="n">slot_values</span></div>


<div class="viewcode-block" id="load_word_vectors"><a class="viewcode-back" href="../../../../../convlab.modules.word_dst.multiwoz.html#convlab.modules.word_dst.multiwoz.mdbt_util.load_word_vectors">[docs]</a><span class="k">def</span> <span class="nf">load_word_vectors</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Load the word embeddings from the url</span>
<span class="sd">    :param url: to the word vectors</span>
<span class="sd">    :return: dict of word and vector values</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">word_vectors</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># print(&quot;Loading the word embeddings....................&quot;)</span>
    <span class="c1"># print(&#39;abs path: &#39;, os.path.abspath(url))</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">word_vectors</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="c1"># print(&quot;\tMDBT: The vocabulary contains about {} word embeddings&quot;.format(len(word_vectors)))</span>
    <span class="k">return</span> <span class="n">normalise_word_vectors</span><span class="p">(</span><span class="n">word_vectors</span><span class="p">)</span></div>


<div class="viewcode-block" id="track_dialogue"><a class="viewcode-back" href="../../../../../convlab.modules.word_dst.multiwoz.html#convlab.modules.word_dst.multiwoz.mdbt_util.track_dialogue">[docs]</a><span class="k">def</span> <span class="nf">track_dialogue</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ontology</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">overall_accuracy_total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">overall_accuracy_corr</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">joint_accuracy_total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">joint_accuracy_corr</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">global</span> <span class="n">num_slots</span>
    <span class="n">dialogues</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">dialogue</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">turn_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dialogue</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                <span class="n">turn_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">dialogue</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">domains</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="n">turn_ids</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">turns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">previous_terms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">turn_ids</span><span class="p">:</span>
            <span class="n">turn</span> <span class="o">=</span> <span class="n">dialogue</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span>
            <span class="n">user_input</span> <span class="o">=</span> <span class="n">turn</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;text&#39;</span><span class="p">]</span>
            <span class="n">sys_res</span> <span class="o">=</span> <span class="n">turn</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">turn</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;belief_state&#39;</span><span class="p">]</span>
            <span class="n">turn_obj</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">turn_obj</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_input</span>
            <span class="n">turn_obj</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sys_res</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">prediction</span><span class="p">)[:</span><span class="o">-</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">prediction</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">predicted_terms</span> <span class="o">=</span> <span class="p">[</span><span class="n">process_booking</span><span class="p">(</span><span class="n">ontology</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">user_input</span><span class="p">,</span> <span class="n">previous_terms</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>
            <span class="n">previous_terms</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">predicted_terms</span><span class="p">)</span>
            <span class="n">turn_obj</span><span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">predicted_terms</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indices</span><span class="p">)]</span>
            <span class="n">turn_obj</span><span class="p">[</span><span class="s1">&#39;True state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">unpredicted_labels</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">domain</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">domain</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">domains</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">slots</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="n">domain</span><span class="p">][</span><span class="s1">&#39;semi&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">slots</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">slot</span> <span class="o">==</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">slots</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="n">domain</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">slot</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">value</span>
                        <span class="n">turn_obj</span><span class="p">[</span><span class="s1">&#39;True state&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">predicted_terms</span><span class="p">:</span>
                            <span class="n">predicted_terms</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">unpredicted_labels</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">turns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">turn_obj</span><span class="p">)</span>
            <span class="n">overall_accuracy_total</span> <span class="o">+=</span> <span class="n">num_slots</span>
            <span class="n">overall_accuracy_corr</span> <span class="o">+=</span> <span class="p">(</span><span class="n">num_slots</span> <span class="o">-</span> <span class="n">unpredicted_labels</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">predicted_terms</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">unpredicted_labels</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">predicted_terms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">joint_accuracy_corr</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">joint_accuracy_total</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">dialogues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">turns</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dialogues</span><span class="p">,</span> <span class="n">overall_accuracy_corr</span><span class="o">/</span><span class="n">overall_accuracy_total</span><span class="p">,</span> <span class="n">joint_accuracy_corr</span><span class="o">/</span><span class="n">joint_accuracy_total</span></div>


<div class="viewcode-block" id="process_booking"><a class="viewcode-back" href="../../../../../convlab.modules.word_dst.multiwoz.html#convlab.modules.word_dst.multiwoz.mdbt_util.process_booking">[docs]</a><span class="k">def</span> <span class="nf">process_booking</span><span class="p">(</span><span class="n">ontolog_term</span><span class="p">,</span> <span class="n">usr_input</span><span class="p">,</span> <span class="n">previous_terms</span><span class="p">):</span>
    <span class="n">usr_input</span> <span class="o">=</span> <span class="n">usr_input</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">domain</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">ontolog_term</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">slot</span> <span class="o">==</span> <span class="s1">&#39;book&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">previous_terms</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">domain</span><span class="o">+</span><span class="s1">&#39;-book &#39;</span><span class="o">+</span><span class="n">value</span> <span class="ow">in</span> <span class="n">term</span><span class="p">:</span>
                <span class="n">ontolog_term</span> <span class="o">=</span> <span class="n">term</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;stay&#39;</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;people&#39;</span><span class="p">:</span>
                <span class="n">numbers</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">usr_input</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">ontolog_term</span> <span class="o">=</span> <span class="n">domain</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">slot</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">value</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">numbers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">vals</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="n">usr_input</span><span class="p">[</span><span class="n">usr_input</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">numbers</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;people&#39;</span><span class="p">,</span> <span class="s1">&#39;person&#39;</span><span class="p">]:</span>
                        <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;people&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">numbers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;stay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">numbers</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;people&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">numbers</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;stay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">numbers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">ontolog_term</span> <span class="o">=</span> <span class="n">domain</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">slot</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">value</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">vals</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">booking_slots</span><span class="p">[</span><span class="n">domain</span><span class="o">+</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="n">value</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">val</span> <span class="ow">in</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">usr_input</span><span class="p">):</span>
                        <span class="n">ontolog_term</span> <span class="o">=</span> <span class="n">domain</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">slot</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">value</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">val</span>
                        <span class="k">break</span>
    <span class="k">return</span> <span class="n">ontolog_term</span></div>


<div class="viewcode-block" id="process_history"><a class="viewcode-back" href="../../../../../convlab.modules.word_dst.multiwoz.html#convlab.modules.word_dst.multiwoz.mdbt_util.process_history">[docs]</a><span class="k">def</span> <span class="nf">process_history</span><span class="p">(</span><span class="n">sessions</span><span class="p">,</span> <span class="n">word_vectors</span><span class="p">,</span> <span class="n">ontology</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Load the woz3 data and extract feature vectors</span>
<span class="sd">    :param data: the data to load</span>
<span class="sd">    :param word_vectors: word embeddings</span>
<span class="sd">    :param ontology: list of domain-slot-value</span>
<span class="sd">    :param url: Is the data coming from a url, default true</span>
<span class="sd">    :return: list(num of turns, user_input vectors, system_response vectors, labels)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">dialogues</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">actual_dialogues</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">dialogue</span> <span class="ow">in</span> <span class="n">sessions</span><span class="p">:</span>
        <span class="n">turn_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dialogue</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                <span class="n">turn_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">dialogue</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">domains</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="n">turn_ids</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">num_turns</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">turn_ids</span><span class="p">)</span>
        <span class="n">user_vecs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sys_vecs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">turn_labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">turn_domain_labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">add</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">good</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">pre_sys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">max_utterance_length</span><span class="p">,</span> <span class="n">vector_dimension</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">turn_ids</span><span class="p">:</span>
            <span class="n">turn</span> <span class="o">=</span> <span class="n">dialogue</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span>
            <span class="n">user_v</span><span class="p">,</span> <span class="n">sys_v</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">domain_labels</span> <span class="o">=</span> <span class="n">process_turn</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">word_vectors</span><span class="p">,</span> <span class="n">ontology</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">good</span> <span class="ow">and</span> <span class="p">(</span><span class="n">user_v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_utterance_length</span> <span class="ow">or</span> <span class="n">pre_sys</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_utterance_length</span><span class="p">):</span>
                <span class="c1"># cut overlength utterance instead of discarding them</span>
                <span class="k">if</span> <span class="n">user_v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_utterance_length</span><span class="p">:</span>
                    <span class="n">user_v</span> <span class="o">=</span> <span class="n">user_v</span><span class="p">[:</span><span class="n">max_utterance_length</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">pre_sys</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_utterance_length</span><span class="p">:</span>
                    <span class="n">pre_sys</span> <span class="o">=</span> <span class="n">pre_sys</span><span class="p">[:</span><span class="n">max_utterance_length</span><span class="p">]</span>
                <span class="c1"># good = False</span>
                <span class="c1"># break</span>
            <span class="n">user_vecs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_v</span><span class="p">)</span>
            <span class="n">sys_vecs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pre_sys</span><span class="p">)</span>
            <span class="n">turn_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
            <span class="n">turn_domain_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">domain_labels</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">add</span> <span class="ow">and</span> <span class="nb">sum</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">add</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">pre_sys</span> <span class="o">=</span> <span class="n">sys_v</span>
        <span class="k">if</span> <span class="n">add</span> <span class="ow">and</span> <span class="n">good</span><span class="p">:</span>
            <span class="n">dialogues</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">num_turns</span><span class="p">,</span> <span class="n">user_vecs</span><span class="p">,</span> <span class="n">sys_vecs</span><span class="p">,</span> <span class="n">turn_labels</span><span class="p">,</span> <span class="n">turn_domain_labels</span><span class="p">))</span>
            <span class="n">actual_dialogues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dialogue</span><span class="p">)</span>
    <span class="c1"># print(&quot;\tMDBT: The data contains about {} dialogues&quot;.format(len(dialogues)))</span>
    <span class="k">return</span> <span class="n">dialogues</span><span class="p">,</span> <span class="n">actual_dialogues</span></div>


<div class="viewcode-block" id="load_woz_data"><a class="viewcode-back" href="../../../../../convlab.modules.word_dst.multiwoz.html#convlab.modules.word_dst.multiwoz.mdbt_util.load_woz_data">[docs]</a><span class="k">def</span> <span class="nf">load_woz_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">word_vectors</span><span class="p">,</span> <span class="n">ontology</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Load the woz3 data and extract feature vectors</span>
<span class="sd">    :param data: the data to load</span>
<span class="sd">    :param word_vectors: word embeddings</span>
<span class="sd">    :param ontology: list of domain-slot-value</span>
<span class="sd">    :param url: Is the data coming from a url, default true</span>
<span class="sd">    :return: list(num of turns, user_input vectors, system_response vectors, labels)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">url</span><span class="p">:</span>
        <span class="c1"># print(&quot;Loading data from url {} ....................&quot;.format(data))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">))</span>

    <span class="n">dialogues</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">actual_dialogues</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">dialogue</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">turn_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dialogue</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                <span class="n">turn_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">dialogue</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">domains</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="n">turn_ids</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">num_turns</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">turn_ids</span><span class="p">)</span>
        <span class="n">user_vecs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sys_vecs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">turn_labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">turn_domain_labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">add</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">good</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">pre_sys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">max_utterance_length</span><span class="p">,</span> <span class="n">vector_dimension</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">turn_ids</span><span class="p">:</span>
            <span class="n">turn</span> <span class="o">=</span> <span class="n">dialogue</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span>
            <span class="n">user_v</span><span class="p">,</span> <span class="n">sys_v</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">domain_labels</span> <span class="o">=</span> <span class="n">process_turn</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">word_vectors</span><span class="p">,</span> <span class="n">ontology</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">good</span> <span class="ow">and</span> <span class="p">(</span><span class="n">user_v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_utterance_length</span> <span class="ow">or</span> <span class="n">pre_sys</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_utterance_length</span><span class="p">):</span>
                <span class="n">good</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
            <span class="n">user_vecs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_v</span><span class="p">)</span>
            <span class="n">sys_vecs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pre_sys</span><span class="p">)</span>
            <span class="n">turn_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
            <span class="n">turn_domain_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">domain_labels</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">add</span> <span class="ow">and</span> <span class="nb">sum</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">add</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">pre_sys</span> <span class="o">=</span> <span class="n">sys_v</span>
        <span class="k">if</span> <span class="n">add</span> <span class="ow">and</span> <span class="n">good</span><span class="p">:</span>
            <span class="n">dialogues</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">num_turns</span><span class="p">,</span> <span class="n">user_vecs</span><span class="p">,</span> <span class="n">sys_vecs</span><span class="p">,</span> <span class="n">turn_labels</span><span class="p">,</span> <span class="n">turn_domain_labels</span><span class="p">))</span>
            <span class="n">actual_dialogues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dialogue</span><span class="p">)</span>
    <span class="c1"># print(&quot;\tMDBT: The data contains about {} dialogues&quot;.format(len(dialogues)))</span>
    <span class="k">return</span> <span class="n">dialogues</span><span class="p">,</span> <span class="n">actual_dialogues</span></div>


<div class="viewcode-block" id="process_turn"><a class="viewcode-back" href="../../../../../convlab.modules.word_dst.multiwoz.html#convlab.modules.word_dst.multiwoz.mdbt_util.process_turn">[docs]</a><span class="k">def</span> <span class="nf">process_turn</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">word_vectors</span><span class="p">,</span> <span class="n">ontology</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Process a single turn extracting and processing user text, system response and labels</span>
<span class="sd">    :param turn: dict</span>
<span class="sd">    :param word_vectors: word embeddings</span>
<span class="sd">    :param ontology: list(domain-slot-value)</span>
<span class="sd">    :return: ([utterance length, 300], [utterance length, 300], [no_slots])</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">user_input</span> <span class="o">=</span> <span class="n">turn</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;text&#39;</span><span class="p">]</span>
    <span class="n">sys_res</span> <span class="o">=</span> <span class="n">turn</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">turn</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;belief_state&#39;</span><span class="p">]</span>
    <span class="n">user_v</span> <span class="o">=</span> <span class="n">process_text</span><span class="p">(</span><span class="n">user_input</span><span class="p">,</span> <span class="n">word_vectors</span><span class="p">,</span> <span class="n">ontology</span><span class="p">)</span>
    <span class="n">sys_v</span> <span class="o">=</span> <span class="n">process_text</span><span class="p">(</span><span class="n">sys_res</span><span class="p">,</span> <span class="n">word_vectors</span><span class="p">,</span> <span class="n">ontology</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ontology</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
    <span class="n">domain_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ontology</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">domain</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">domain</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">domains</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">slots</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="n">domain</span><span class="p">][</span><span class="s1">&#39;semi&#39;</span><span class="p">]</span>
        <span class="n">domain_mention</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">slots</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">slot</span> <span class="o">==</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">slots</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;book&quot;</span> <span class="ow">in</span> <span class="n">slot</span><span class="p">:</span>
                <span class="p">[</span><span class="n">slot</span><span class="p">,</span> <span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="n">slot</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;corsican&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">slot</span> <span class="o">==</span> <span class="s2">&quot;destination&quot;</span> <span class="ow">or</span> <span class="n">slot</span> <span class="o">==</span> <span class="s2">&quot;departure&quot;</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;place&quot;</span>
                <span class="k">elif</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;09;45&#39;</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;09:45&#39;</span>
                <span class="k">elif</span> <span class="s1">&#39;alpha-milton&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;alpha-milton&#39;</span><span class="p">,</span> <span class="s1">&#39;alpha milton&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;east side&#39;</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;east&#39;</span>
                <span class="k">elif</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39; expensive&#39;</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;expensive&#39;</span>
                <span class="n">labels</span><span class="p">[</span><span class="n">ontology</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">domain</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">slot</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">value</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">domain_mention</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">domain_mention</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">slot</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ontology</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">domain</span> <span class="ow">in</span> <span class="n">slot</span><span class="p">:</span>
                    <span class="n">domain_labels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">user_v</span><span class="p">,</span> <span class="n">sys_v</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">domain_labels</span></div>


<div class="viewcode-block" id="process_text"><a class="viewcode-back" href="../../../../../convlab.modules.word_dst.multiwoz.html#convlab.modules.word_dst.multiwoz.mdbt_util.process_text">[docs]</a><span class="k">def</span> <span class="nf">process_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">word_vectors</span><span class="p">,</span> <span class="n">ontology</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">print_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Process a line/sentence converting words to feature vectors</span>
<span class="sd">    :param text: sentence</span>
<span class="sd">    :param word_vectors: word embeddings</span>
<span class="sd">    :param ontology: The ontology to do exact matching</span>
<span class="sd">    :param print_mode: Log the cases where the word is not in the pre-trained word vectors</span>
<span class="sd">    :return: [length of sentence, 300]</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;’&quot;</span><span class="p">,</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;‘&quot;</span><span class="p">,</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39; / &#39;</span><span class="p">)</span>\
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ontology</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">ontology</span><span class="p">:</span>
            <span class="p">[</span><span class="n">domain</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="n">slot</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
            <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">domain</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>\
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">slot</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>\
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>

    <span class="n">words</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

    <span class="n">vectors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">:</span>
        <span class="n">word</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;!&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">word</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">word_vectors</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">length</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">word</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">word_vectors</span> <span class="ow">and</span> <span class="n">word</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span> <span class="ow">in</span> <span class="n">word_vectors</span><span class="p">:</span>
                    <span class="n">vec</span> <span class="o">=</span> <span class="n">word_vectors</span><span class="p">[</span><span class="n">word</span><span class="p">[:</span><span class="n">i</span><span class="p">]]</span> <span class="o">+</span> <span class="n">word_vectors</span><span class="p">[</span><span class="n">word</span><span class="p">[</span><span class="n">i</span><span class="p">:]]</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vec</span> <span class="o">=</span> <span class="n">xavier_vector</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
                <span class="n">word_vectors</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">vec</span>
                <span class="k">if</span> <span class="n">print_mode</span><span class="p">:</span>
                    <span class="k">pass</span>
                    <span class="c1"># print(&quot;\tMDBT: Adding new word: {}&quot;.format(word))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vec</span> <span class="o">=</span> <span class="n">word_vectors</span><span class="p">[</span><span class="n">word</span><span class="p">]</span>
        <span class="n">vectors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">vectors</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="generate_batch"><a class="viewcode-back" href="../../../../../convlab.modules.word_dst.multiwoz.html#convlab.modules.word_dst.multiwoz.mdbt_util.generate_batch">[docs]</a><span class="k">def</span> <span class="nf">generate_batch</span><span class="p">(</span><span class="n">dialogues</span><span class="p">,</span> <span class="n">batch_no</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">ontology_size</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Generate examples for minibatch training</span>
<span class="sd">    :param dialogues: list(num of turns, user_input vectors, system_response vectors, labels)</span>
<span class="sd">    :param batch_no: where we are in the training data</span>
<span class="sd">    :param batch_size: number of dialogues to generate</span>
<span class="sd">    :param ontology_size: no_slots</span>
<span class="sd">    :return: list(user_input, system_response, labels, user_sentence_length, system_sentence_length, number of turns)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">max_no_turns</span><span class="p">,</span> <span class="n">max_utterance_length</span><span class="p">,</span> <span class="n">vector_dimension</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
    <span class="n">sys_res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">max_no_turns</span><span class="p">,</span> <span class="n">max_utterance_length</span><span class="p">,</span> <span class="n">vector_dimension</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">max_no_turns</span><span class="p">,</span> <span class="n">ontology_size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
    <span class="n">domain_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">max_no_turns</span><span class="p">,</span> <span class="n">ontology_size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
    <span class="n">user_uttr_len</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">max_no_turns</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
    <span class="n">sys_uttr_len</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">max_no_turns</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
    <span class="n">no_turns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_no</span><span class="o">*</span><span class="n">train_batch_size</span><span class="p">,</span> <span class="n">batch_no</span><span class="o">*</span><span class="n">train_batch_size</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">):</span>
        <span class="p">(</span><span class="n">num_turns</span><span class="p">,</span> <span class="n">user_vecs</span><span class="p">,</span> <span class="n">sys_vecs</span><span class="p">,</span> <span class="n">turn_labels</span><span class="p">,</span> <span class="n">turn_domain_labels</span><span class="p">)</span> <span class="o">=</span> <span class="n">dialogues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">no_turns</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_turns</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_turns</span><span class="p">):</span>
            <span class="n">user_uttr_len</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_vecs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">sys_uttr_len</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sys_vecs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">user</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:</span><span class="n">user_uttr_len</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">user_vecs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">sys_res</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:</span><span class="n">sys_uttr_len</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">sys_vecs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">turn_labels</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">domain_labels</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">turn_domain_labels</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">user</span><span class="p">,</span> <span class="n">sys_res</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">domain_labels</span><span class="p">,</span> <span class="n">user_uttr_len</span><span class="p">,</span> <span class="n">sys_uttr_len</span><span class="p">,</span> <span class="n">no_turns</span></div>


<div class="viewcode-block" id="evaluate_model"><a class="viewcode-back" href="../../../../../convlab.modules.word_dst.multiwoz.html#convlab.modules.word_dst.multiwoz.mdbt_util.evaluate_model">[docs]</a><span class="k">def</span> <span class="nf">evaluate_model</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">model_variables</span><span class="p">,</span> <span class="n">val_data</span><span class="p">,</span> <span class="n">summary</span><span class="p">,</span> <span class="n">batch_id</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Evaluate the model against validation set</span>
<span class="sd">    :param sess: training session</span>
<span class="sd">    :param model_variables: all model input variables</span>
<span class="sd">    :param val_data: validation data</span>
<span class="sd">    :param summary: For tensorboard</span>
<span class="sd">    :param batch_id: where we are in the training data</span>
<span class="sd">    :param i: the index of the validation data to load</span>
<span class="sd">    :return: evaluation accuracy and the summary</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">sys_res</span><span class="p">,</span> <span class="n">no_turns</span><span class="p">,</span> <span class="n">user_uttr_len</span><span class="p">,</span> <span class="n">sys_uttr_len</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">domain_labels</span><span class="p">,</span> <span class="n">domain_accuracy</span><span class="p">,</span>
     <span class="n">slot_accuracy</span><span class="p">,</span> <span class="n">value_accuracy</span><span class="p">,</span> <span class="n">value_f1</span><span class="p">,</span> <span class="n">train_step</span><span class="p">,</span> <span class="n">keep_prob</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">model_variables</span>

    <span class="n">batch_user</span><span class="p">,</span> <span class="n">batch_sys</span><span class="p">,</span> <span class="n">batch_labels</span><span class="p">,</span> <span class="n">batch_domain_labels</span><span class="p">,</span> <span class="n">batch_user_uttr_len</span><span class="p">,</span> <span class="n">batch_sys_uttr_len</span><span class="p">,</span> \
        <span class="n">batch_no_turns</span> <span class="o">=</span> <span class="n">val_data</span>

    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">b_z</span> <span class="o">=</span> <span class="n">train_batch_size</span>
    <span class="p">[</span><span class="n">precision</span><span class="p">,</span> <span class="n">recall</span><span class="p">,</span> <span class="n">value_f1</span><span class="p">]</span> <span class="o">=</span> <span class="n">value_f1</span>
    <span class="p">[</span><span class="n">d_acc</span><span class="p">,</span> <span class="n">s_acc</span><span class="p">,</span> <span class="n">v_acc</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">re</span><span class="p">,</span> <span class="n">sm1</span><span class="p">,</span> <span class="n">sm2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">domain_accuracy</span><span class="p">,</span> <span class="n">slot_accuracy</span><span class="p">,</span> <span class="n">value_accuracy</span><span class="p">,</span>
                                                                  <span class="n">value_f1</span><span class="p">,</span> <span class="n">precision</span><span class="p">,</span> <span class="n">recall</span><span class="p">]</span> <span class="o">+</span> <span class="n">summary</span><span class="p">,</span>
                                                           <span class="n">feed_dict</span><span class="o">=</span><span class="p">{</span><span class="n">user</span><span class="p">:</span> <span class="n">batch_user</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">b_z</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:],</span>
                                                                      <span class="n">sys_res</span><span class="p">:</span> <span class="n">batch_sys</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">b_z</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:],</span>
                                                                      <span class="n">labels</span><span class="p">:</span> <span class="n">batch_labels</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">b_z</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span>
                                                                      <span class="n">domain_labels</span><span class="p">:</span> <span class="n">batch_domain_labels</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">b_z</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span>
                                                                      <span class="n">user_uttr_len</span><span class="p">:</span> <span class="n">batch_user_uttr_len</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">b_z</span><span class="p">,</span> <span class="p">:],</span>
                                                                      <span class="n">sys_uttr_len</span><span class="p">:</span> <span class="n">batch_sys_uttr_len</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">b_z</span><span class="p">,</span> <span class="p">:],</span>
                                                                      <span class="n">no_turns</span><span class="p">:</span> <span class="n">batch_no_turns</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">b_z</span><span class="p">],</span>
                                                                      <span class="n">keep_prob</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">})</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Batch&quot;</span><span class="p">,</span> <span class="n">batch_id</span><span class="p">,</span> <span class="s2">&quot;[Domain Accuracy] = &quot;</span><span class="p">,</span> <span class="n">d_acc</span><span class="p">,</span> <span class="s2">&quot;[Slot Accuracy] = &quot;</span><span class="p">,</span> <span class="n">s_acc</span><span class="p">,</span> <span class="s2">&quot;[Value Accuracy] = &quot;</span><span class="p">,</span>
          <span class="n">v_acc</span><span class="p">,</span> <span class="s2">&quot;[F1 Score] = &quot;</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="s2">&quot;[Precision] = &quot;</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="s2">&quot;[Recall] = &quot;</span><span class="p">,</span> <span class="n">re</span><span class="p">,</span>
          <span class="s2">&quot; ----- &quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
          <span class="s2">&quot;seconds. ---&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">d_acc</span><span class="p">,</span> <span class="n">s_acc</span><span class="p">,</span> <span class="n">v_acc</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">sm1</span><span class="p">,</span> <span class="n">sm2</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ConvLab

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>